---
title: "Assignment3 msb104"
author: Frida Alendal og Katinca Valvatne 
lang: NO_nb
editor: visual
toc: true
number-sections: true
format:
  pdf:
    pdf-engine: xelatex
    geometry: margin=2.5cm
    keep-tex: false
execute:
  echo: true      # vis kode
  # ag: vil anbefale å ha disse på mens dere utvikler
  # kan slås av for endelig rapport
  warning: false  # skjul advarsler i output
  message: false  # skjul meldinger i output
---




```{r}
# Laster nødvendige pakker for del A
library(dplyr)
library(ggplot2)
```

```{r}
# Last inn data_B3 fra Assignment 2
data_B3 <- readRDS("data/data_B3.rds")

```

```{r}

list.files("data")

```

```{r}

# Laster inn datasett som ble lagret i Assignment 1/2
gini_nuts2_year <- readRDS("data/gini_nuts2_year.rds")
dev_2000_2017   <- readRDS("data/dev_2000_2017.rds")

```


# Del A: Testing av utviklingseffekter på tvers av undergrupper

```{r}

# Forutsetter at data_B3 er laget som i Assignment 2
# Vi lager tre grupper basert på tertiler av høyere utdanning

data_A <- data_B3 %>% 
  mutate(
    edu_group3 = cut(
      edu_tertiary,
      breaks = quantile(edu_tertiary, probs = c(0, 1/3, 2/3, 1)),
      include.lowest = TRUE,
      labels = c("Low edu", "Mid edu", "High edu")
    )
  )

# Sjekk at gruppene ble rimelige
data_A %>% 
  count(edu_group3)

```

```{r}
# Regresjon gini ~ utvikling (dev_log) i hver utdanningsgruppe

mod_low  <- lm(gini_w ~ dev_log, data = filter(data_A, edu_group3 == "Low edu"))
mod_mid  <- lm(gini_w ~ dev_log, data = filter(data_A, edu_group3 == "Mid edu"))
mod_high <- lm(gini_w ~ dev_log, data = filter(data_A, edu_group3 == "High edu"))

summary(mod_low)
summary(mod_mid)
summary(mod_high)

```

```{r}
# Modell uten interaksjon: samme dev_log-effekt i alle grupper
mod_no_int <- lm(gini_w ~ dev_log + edu_group3, data = data_A)

# Modell MED interaksjon: dev_log-effekt kan være ulik i gruppene
mod_int <- lm(gini_w ~ dev_log * edu_group3, data = data_A)

summary(mod_int)

```



```{r}
# Likhetstest for helninger: 
# H0: samme dev_log-effekt i alle grupper
anova(mod_no_int, mod_int)

```

```{r}
ggplot(data_A, aes(x = dev_log, y = gini_w, colour = edu_group3)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE) +
  labs(
    x = "Regional utvikling (log BNP per innbygger)",
    y = "Gini-koeffisient",
    colour = "Utdanningsnivå"
  ) +
  theme_bw()

```

## Drøfting av delutvalgsanalyse 

For å undersøke om sammenhengen mellom økonomisk utvikling og ulikhet varierer med utdanningsnivå, deler vi regionene inn i tre like store grupper basert på andel med høyere utdanning (low, mid, high edu). Hver gruppe inneholder sju regioner. Vi estimerer deretter en enkel regresjon mellom utvikling (dev_log) og ulikhet (gini_w) innen hver gruppe.

I gruppen med lavt utdanningsnivå er helningen svakt negativ, og p-verdien er høy (omtrent 0,55). Det betyr at vi ikke finner noen robust statistisk sammenheng mellom utvikling og ulikhet i denne gruppen. For "mid edu" er helningen positiv og større i størrelse, men fortsatt ikke signifikant på vanlige nivåer. I high edu-gruppen er helningen positiv og signifikant på 5-prosentnivå. Dette tyder på at i regioner med høy andel høyere utdanning henger høyere økonomisk utvikling sammen med høyere ulikhet, mens bildet er svakere eller fraværende i de to andre gruppene.

Samtidig er utvalget lite (kun sju observasjoner per gruppe), noe som gir brede konfidensintervall og usikre anslag. En formell likhetstest mellom modell uten og med interaksjonsledd (dev_log*edu_group3) gir en p-verdi rundt 0,23 slik at vi ikke kan avvise hypotesen om felles helning på tvers av grupper. Delutvalgsanalysen bør derfor tolkes som indikasjoner på mulig heterogenitet, ikke som sterke kausale bevis. Den illustrerer likevel hvordan delutvalg kan brukes til å utforske om en samlet sammenheng drives av bestemte undergrupper.



# Del B: Utforskning av alternative funksjonelle former

## Funksjonell form-utforskning

Vi tester kvadratiske og kubiske modeller for å undersøke om forholdet mellom utvikling og ulikhet kan være ikke-linært. Økonomisk teori, som Kuznets-hypotesen, tilsier at ulikhet kan øke i tidlige utviklingsfaser og deretter avta (Kuznets, 1955). En lineær modell kan ikke fange slike bøyde sammenhenger. Ved å inkludere høyere ordens ledd gir vi modellen fleksibilitet til å avdekke mer komplekse mønstre i dataene.


```{r}
# Lager et rent datasett for del B med bare variablene vi trenger
data_B <- data_B3 |>
  dplyr::select(NUTS2, gini_w, dev_log)

```


```{r}
# Lager kvadratisk og kubisk form av dev_log
data_B <- data_B |>
  dplyr::mutate(
    dev_log2 = dev_log^2,      # dev_log i andre
    dev_log3 = dev_log^3       # dev_log i tredje
  )

# Sjekk at variablene ser fornuftige ut
dplyr::glimpse(data_B)

```


```{r}
# Referansemodell: lineær sammenheng mellom utvikling og ulikhet
mod_lin <- lm(gini_w ~ dev_log, data = data_B)

# Alternativ 1: kvadratisk funksjon (tillater bøyd kurve)
mod_quad <- lm(gini_w ~ dev_log + dev_log2, data = data_B)

# Alternativ 2: kubisk funksjon (enda mer fleksibel kurve)
mod_cubic <- lm(gini_w ~ dev_log + dev_log2 + dev_log3, data = data_B)

# Viser resultatene (Katinca bruker dette til å beskrive koeffisienter og signifikans)
summary(mod_lin)
summary(mod_quad)
summary(mod_cubic)

```



```{r}
# Samler nøkkeltall fra modellene i en liten tabell
model_comp <- tibble::tibble(
  modell   = c("Lineær", "Kvadratisk", "Kubisk"),
  R2       = c(summary(mod_lin)$r.squared,
              summary(mod_quad)$r.squared,
              summary(mod_cubic)$r.squared),
  adj_R2   = c(summary(mod_lin)$adj.r.squared,
              summary(mod_quad)$adj.r.squared,
              summary(mod_cubic)$adj.r.squared),
  AIC      = c(AIC(mod_lin), AIC(mod_quad), AIC(mod_cubic))
)

model_comp

```

## Estimering og visualisering 

Figuren viser datapunktene sammen med tre prediksjonskurver: lineær, kvadratisk og kubisk modell. Den lineære kurven viser en jevn, positiv trend mellom utvikling og ulikhet. Den kubiske kurven følger datapunktene tettere, særlig i ytterkantene, og indikerer svake ikke-lineære trekk. Likevel er forskjellen i kurvene moderat og hovedinntrykket er en svak positiv sammenheng. Dette gir ingen sterk støtte for en typisk Kuznets-form i dette datasettet. 



```{r}
# Lager et "grid" av dev_log-verdier for å plotte glatte prediksjonskurver
pred_grid <- data.frame(
  dev_log = seq(
    from = min(data_B$dev_log, na.rm = TRUE),
    to   = max(data_B$dev_log, na.rm = TRUE),
    length.out = 200
  )
)

# Lag kvadratisk og kubisk variant også i pred_grid
pred_grid <- pred_grid |>
  dplyr::mutate(
    dev_log2 = dev_log^2,
    dev_log3 = dev_log^3
  )

# Predikert Gini for hver modell på samme grid
pred_grid$gini_lin   <- predict(mod_lin,   newdata = pred_grid)
pred_grid$gini_quad  <- predict(mod_quad,  newdata = pred_grid)
pred_grid$gini_cubic <- predict(mod_cubic, newdata = pred_grid)

```



```{r}
# Plotter datapunkter + tre kurver for de ulike funksjonelle formene
ggplot(data_B, aes(x = dev_log, y = gini_w)) +
  geom_point() +
  geom_line(data = pred_grid,
            aes(y = gini_lin, colour = "Lineær")) +
  geom_line(data = pred_grid,
            aes(y = gini_quad, colour = "Kvadratisk")) +
  geom_line(data = pred_grid,
            aes(y = gini_cubic, colour = "Kubisk")) +
  labs(
    x      = "Regional utvikling (log BNP per innbygger)",
    y      = "Gini-koeffisient",
    colour = "Funksjonell form"
  ) +
  theme_bw()

```

## Tolkning av resultater

Den lineære modellen mellom utvikling (dev_log) og ulikhet (gini_w) gir en positiv helning på om lag 0,086, som er signifikant på 5-prosentnivå. Dette betyr at regioner med høyere økonomisk utvikling i gjennomsnitt har høyere inntektsulikhet. Forklaringskraften er moderat (R² ≈ 0,22), men modellen gir et enkelt og tolkningsvennlig bilde.

Når vi går over til en kvadratisk modell, øker R² svakt til 0,24, men verken dev_log eller dev_log² er signifikante enkeltvis, og F-testen for modellen som helhet er kun marginalt signifikant på rundt 10-prosentnivå. Det tyder på at dataene ikke gir tydelig støtte til en klassisk Kuznets-kurve med et klart toppunkt der ulikheten først øker og deretter faller.

Den kubiske modellen gir høyest forklaringskraft (R² ≈ 0,37) og lavest AIC, og er dermed den modellen som best fanger variasjonen i gini_w gitt dette datasettet. Samlet F-test er signifikant, men de enkelte koeffisientene er kun svakt signifikante, og prøven er liten. Den kubiske kurven følger datapunktene noe tettere enn den lineære, særlig i ytterkantene og antyder svak ikke-linearitet, men forskjellen i predikert forløp er begrenset.

Sammenlignet med den opprinnelige lineære modellen endrer de alternative funksjonelle formene derfor ikke hovedbudskapet. Vi finner en svak positiv sammenheng mellom regional utvikling og ulikhet, uten klar evidens for en sterk bøyet Kuznets-relasjon. Den kubiske modellen beskriver dataene best etter tradisjonelle mål (R² og AIC), men gitt få observasjoner og usikre koeffisienter legger vi mest vekt på tolkning som en robust, en relativt svak, positiv sammenheng. 




# Del C: Test for heteroskedastisitet og drøfting av kausalitet 

## Heteroskedastisitetstesting 

Heteroskedastisitet betyr at variansen i feilleddet (residualene) ikke er konstant. Dette kan gjøre standardfeil upålitelige og føre til feil signifikansvurderinger (Wooldridge, 2020, kap.8). Breusch-Pagan-testen viser ingen signifikant heteroskedastisitet i våre modeller, noe som betyr at standardfeilene anses som pålitelige og kan brukes til inferens. 



```{r}
# Laster inn pakker for heteroskedastisitetstest
library(lmtest)
library(sandwich)

# Breusch–Pagan-test for lineær, kvadratisk og kubisk modell
bp_lin   <- bptest(mod_lin)
bp_quad  <- bptest(mod_quad)
bp_cubic <- bptest(mod_cubic)

bp_lin
bp_quad
bp_cubic
```

```{r}
# Samler Breusch–Pagan-resultater i en liten tabell
het_tests <- tibble::tibble(
  modell  = c("Lineær", "Kvadratisk", "Kubisk"),
  BP_stat = c(bp_lin$statistic,  bp_quad$statistic,  bp_cubic$statistic),
  df      = c(bp_lin$parameter,  bp_quad$parameter,  bp_cubic$parameter),
  p_value = c(bp_lin$p.value,    bp_quad$p.value,    bp_cubic$p.value)
)

het_tests  # Tabell Katinca kan bruke i teksten

```


## Kausalitetsdrøfting

Selv om utvikling og ulikhet korrelerer i dataene våre, kan vi ikke uten videre tolke dette som en kausal effekt. Et første viktig problem er omvendt kausalitet. Ulikhet kan påvirke hvor godt en region utvikler seg, for eksempel gjennom investeringsinsentiver, arbeidskraftmobilitet eller politisk stabilitet. Dersom dette er tilfellet, vil regresjonen feilaktig tolke ulikhetsendringer som effekt av utvikling.

En annen sentral utfordring er utelatte variabler. Regionale forskjeller i arbeidsmarkedsstruktur, institusjoner, demografi, industriell spesialisering og velferdspolitikk kan påvirke både utvikling og ulikhet samtidig. Dersom slike faktorer ikke kontrolleres for, blir estimatet på dev_log skjevt. 

Målfeil kan også spille inn. BNP per innbygger på regionalt nivå er usikkert anslått, og ulikhetsmål som Gini kan være påvirket av underrapportering av inntekter i enkelte land. Slike feil kan føre til at sammenhengen undervurderes. 

Videre forskning kan styrke kausaliteten ved å:
- Bruke instrumentvariabler som gir eksogen variasjon i utvikling
- Inkludere flere tidsvarierende kontrollvariabler
- Undersøke tidsforsinkede effekter (laggede analyser)
- Utnytte politiske endringer eller EU-støtteprogram som naturlige eksperimenter 

Vår analyse gir derfor et deskriptivt bilde av sammenhengen, men uten solid grunnlag for en årsaksslutning uten videre metodiske forbedringer.




# Del D: Panelestimat

## Panelestimeringsoppgave

Vi bruker paneldata med alle regioner og år for å undersøke effekten av utvikling på ulikhet. Ved å inkludere faste effekter for land, region og år kontrollerer vi for konstante forskjeller mellom regioner (som historisk institusjonskvalitet), samt felles sjokk for alle regioner i samme år (f.eks. finanskrise). Dette gjør at vi estimerer effekten basert på innen-regions endringer over tid, noe som gir en mer troverdig analyse enn ren tverrsnitts sammenligning. 



```{r}
#Laster inn pakke for paneldata
library(plm)
```

```{r}
# Lager paneldatasett med variablene vi trenger
panel_data <- gini_nuts2_year %>%
  # slår inn utviklingsvariabelen dev_log fra dev_2000_2017
  dplyr::left_join(
    dev_2000_2017 %>%
      dplyr::select(NUTS2, dev_log),   # bare NUTS2 og dev_log her
    by = "NUTS2"                       # join KUN på NUTS2
  ) %>%
  # tar bare med de variablene vi trenger videre
  dplyr::select(country, NUTS2, year, gini_w, dev_log)

dplyr::glimpse(panel_data)

```
```{r}
# Definerer panel-struktur

# Panel 1: NUTS2 × år (region-år-panel)
panel_p_nuts2 <- plm::pdata.frame(
  panel_data,
  index = c("NUTS2", "year")
)

# Panel 2: land × år (land-år-panel)
panel_p_country <- plm::pdata.frame(
  panel_data,
  index = c("country", "year")
)

# Sjekk at alt ser greit ut
dplyr::glimpse(panel_p_nuts2)

```


```{r}
# Estimerer panelmodeller med faste effekter via dummier (lm)

# Modell 1: Land-faste effekter (country-FE)
mod_fe_country <- lm(
  gini_w ~ dev_log + factor(country),
  data = panel_data
)

# Modell 2: Års-faste effekter (year-FE)
mod_fe_year <- lm(
  gini_w ~ dev_log + factor(year),
  data = panel_data
)

# Modell 3: NUTS2-faste effekter (region-FE)
mod_fe_nuts2 <- lm(
  gini_w ~ dev_log + factor(NUTS2),
  data = panel_data
)

# Modell 4: NUTS2- og år-faste effekter samtidig
mod_fe_nuts2_year <- lm(
  gini_w ~ dev_log + factor(NUTS2) + factor(year),
  data = panel_data
)

# Viser resultatene (Katinca bruker dette i teksten)
summary(mod_fe_country)
summary(mod_fe_year)
summary(mod_fe_nuts2)
summary(mod_fe_nuts2_year)

```


## Sammenlikningstabell (presentasjon av resultatene)


```{r}
# Samler nøkkeltall fra panelmodellene i en tabell
panel_comp <- tibble::tibble(
  modell    = c("Land-FE", "År-FE", "NUTS2-FE", "NUTS2+år-FE"),
  beta_dev  = c(
    coef(mod_fe_country)["dev_log"],
    coef(mod_fe_year)["dev_log"],
    coef(mod_fe_nuts2)["dev_log"],
    coef(mod_fe_nuts2_year)["dev_log"]
  ),
  se_dev    = c(
    summary(mod_fe_country)$coef["dev_log", "Std. Error"],
    summary(mod_fe_year)$coef["dev_log", "Std. Error"],
    summary(mod_fe_nuts2)$coef["dev_log", "Std. Error"],
    summary(mod_fe_nuts2_year)$coef["dev_log", "Std. Error"]
  ),
  p_dev     = c(
    summary(mod_fe_country)$coef["dev_log", "Pr(>|t|)"],
    summary(mod_fe_year)$coef["dev_log", "Pr(>|t|)"],
    summary(mod_fe_nuts2)$coef["dev_log", "Pr(>|t|)"],
    summary(mod_fe_nuts2_year)$coef["dev_log", "Pr(>|t|)"]
  ),
  R2        = c(
    summary(mod_fe_country)$r.squared,
    summary(mod_fe_year)$r.squared,
    summary(mod_fe_nuts2)$r.squared,
    summary(mod_fe_nuts2_year)$r.squared
  ),
  adj_R2    = c(
    summary(mod_fe_country)$adj.r.squared,
    summary(mod_fe_year)$adj.r.squared,
    summary(mod_fe_nuts2)$adj.r.squared,
    summary(mod_fe_nuts2_year)$adj.r.squared
  )
)

panel_comp

```
Resultatene fra panelmodellen viser store forskjeller i koeffisienten for dev_log avhengig av hvilke faste effekter som inkluderes. Når vi kun kontrollerer for felles utvikling over tid (år-faste effekter), er sammenhengen positiv og signifikant. Dette speiler en forenklet observasjon: regioner med høy utvikling har ofte høyere ulikhet.

Når vi derimot legger inn faste effekter for regioner, snur resultatene: sammenhengen blir sterk og signifikant negativ. Det innebærer at når samme region øker sitt utviklingsnivå over tid, så går ulikheten ned. Effekten blir i tillegg mer stabil og presis når både år- og regionspesifikke faste effekter inkluderes.

Den mest troverdige spesifikasjonen er derfor modellen med NUTS-2 og år-faste effekter. Denne kontrollerer for:
- Tid-invariante regionale særtrekk
- Felles europeiske utviklingstrekk hvert år
- Forskjeller i landspolitiske systemer

Konklusjonen blir dermed at uten faste effekter risikerer man å trekke motsatt konklusjon. Det understreker betydningen av paneldata og robust modellspesifikasjon når målet er å isolere reell effekt av økonomisk utvikling. 




# Del E: Kildebruk

## Kilder

Wooldridge, J. M. (2020). Introductory econometrics: A modern approach (7th ed.). Cengage.

Kuznets, S. (1955). Economic growth and income inequality. The American Economic Review, 45(1), 1–28

## Bruk av KI-verktøy (I tråd med HVL sin bruk av KI)

I arbeidet med denne oppgaven har vi brukt KI-verktøy i begrenset omfang og kun som teknisk støtte. Konkret har vi brukt ChatGPT (OpenAI GPT-5.1) gjennom nettleser for å forstå og løse feilmeldinger i R-kode.

Typiske bruksområder var:
- Å kopiere inn feilmeldinger fra R og be om forklaring på hva de betyr
- Å få forslag til små justeringer i kode (for eksempel manglende parenteser, feil i objektnavn eller problemer med nedlastning av pakker).
- Å be om hjelp til å tolke output fra feilmeldingsvinduet når R ikke vil kjøre en chunk.

Denne bruken er etter vår vurdering i tråd med HVL sine retningslinjer for KI, der verktøyet har blitt brukt som støtte for tekniske og praktiske problemer. 











