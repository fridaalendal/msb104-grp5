---
title: "Assignment2 msb104"
author: Frida Alendal og Katinca Valvatne 
lang: NO_nb
editor: visual
toc: true
number-sections: true
format:
  pdf:
    pdf-engine: xelatex
    geometry: margin=2.5cm
    keep-tex: false
execute:
  echo: true      # vis kode
  # ag: vil anbefale å ha disse på mens dere utvikler
  # kan slås av for endelig rapport
  warning: false  # skjul advarsler i output
  message: false  # skjul meldinger i output

---



```{r}
#| label: load-ass1-objects
#| message: false
#| warning: false

# Les alle .rds i data/ og gjør dem tilgjengelige som objekter
rds_files <- list.files("data", pattern = "\\.rds$", full.names = TRUE)
stopifnot(length(rds_files) > 0)   # vennlig feilmelding om mappa er tom

loaded <- lapply(rds_files, readRDS)
names(loaded) <- sub("\\.rds$", "", basename(rds_files))
list2env(loaded, .GlobalEnv)

# Sjekk at nøkkelobjektene finnes
needed <- c("gini_nuts2_year", "dev_2000_2017")
missing <- setdiff(needed, ls())
if (length(missing)) stop("Mangler: ", paste(missing, collapse = ", "),
                         ". Lagre dem først i Ass1 (saveRDS).")

```



# Del A: 


```{r}
# Pakker vi trenger ---------------------------------------------------------
# dplyr/tidyr: datamanipulasjon, broom: pene modelltabeller, ggplot2: figur
library(dplyr)
library(tidyr)
library(broom)
library(ggplot2)

```

```{r}
#| label: setup-data
#| message: false
#| warning: false

library(dplyr)
library(dineq)   # gini.wtd

land <- c("ES","AT","CZ","SI","EE")  # landene deres

# Sjekk at kolonnene finnes (gir klar feilmelding om noe mangler)
stopifnot(all(c("year","gdpc_eur","pop","NUTS2","country","geo") %in% names(gdpc_clean)))

# 1) Avgrens til riktige land og år (bruk YEAR, ikke time)
n3 <- gdpc_clean %>%
  filter(country %in% land, year >= 2000, year <= 2017) %>%
  select(country, NUTS2, geo, year, gdpc = gdpc_eur, pop)

# 2) Aggreger til NUTS-2 per år:
#    - mean_y: pop-vektet BNP p.c.
#    - gini_w: GINI innen NUTS-2 (beregnet fra NUTS-3)
gini_nuts2_year <- n3 %>%
  group_by(country, NUTS2, year) %>%
  summarise(
    n_nuts3 = dplyr::n_distinct(geo),                 # hvor mange NUTS-3 inngår
    mean_y  = weighted.mean(gdpc, pop, na.rm = TRUE), # pop-vektet gj.snitt
    gini_w  = dineq::gini.wtd(gdpc, weights = pop),   # GINI av NUTS-3 verdier
    .groups = "drop"
  )

```





```{r}
library(dplyr)
library(tidyr)

# (A) Avgrens til landene deres (hvis du vil)
land <- c("ES","AT","CZ","SI","EE")
g2 <- gini_nuts2_year %>% filter(country %in% land)

# (B) Finn "baseline"-år per NUTS-2: 2000 hvis finnes, ellers første år ≥ 2000
#    -> Sikrer at regioner som starter i f.eks. 2001 ikke droppes.
base_year <- g2 %>%
  group_by(NUTS2, country) %>%
  summarise(
    y0_year = ifelse(any(year == 2000),
                     2000,
                     min(year[year >= 2000], na.rm = TRUE)),
    .groups = "drop"
  )

# (C) Hent BNP p.c. i baseline-året (y0) og i 2017 (y17)
y0 <- g2 %>%
  inner_join(base_year, by = c("NUTS2","country")) %>%
  filter(year == y0_year) %>%
  transmute(NUTS2, country, y0 = mean_y)

y17 <- g2 %>%
  filter(year == 2017) %>%
  transmute(NUTS2, country, y17 = mean_y)

# (D) Beregn utvikling som log-vekst: log(y17) - log(y0)
#     -> Nå får du med alle regioner som har begge år (baseline og 2017).
dev_2000_2017 <- y0 %>%
  inner_join(y17, by = c("NUTS2","country")) %>%
  mutate(dev_log = log(y17) - log(y0)) %>%
  select(country, NUTS2, dev_log)

# (E) Rask sanity check: hvor mange NUTS-2 fikk vi per land?
dev_2000_2017 %>%
  count(country, name = "n_nuts2")

```



```{r}
# Lager kryss-snittet for 2017 
# 1) GINI i 2017 (målt på NUTS-2). Vi trenger dette som Y-variabel.
gini_2017 <- gini_nuts2_year %>%
  dplyr::filter(year == 2017) %>%
  dplyr::select(country, NUTS2, gini_w, n_nuts3)

# 2) Slå sammen med utviklingsmålet (X-variabelen)
#    -> cs_2017 blir datasettet vi estimerer på.
cs_2017 <- gini_2017 %>%
  dplyr::inner_join(dev_2000_2017, by = c("country","NUTS2"))

# 3) Sjekk hvor mange regioner per land vi faktisk analyserer (din tabell)
coverage <- cs_2017 %>%
  dplyr::count(country, name = "n_nuts2")
coverage

```

## Data og utvalg

Vi analyserer NUTS-2-regioner i **AT, CZ, EE, ES og SI**. Avhengig variabel (**Y**) er **GINI i 2017** på NUTS-2, beregnet fra NUTS-3 med befolkningsvekter. Forklaringsvariabelen (**X**) er **regional utvikling** definert som log-vekst i BNP per innbygger fra første tilgjenlige år ≥ 2000 til 2017.

Vi inkluderer bare regioner som har både baseline og 2017. Dette gir totalt **`r nrow(cs_2017)`** NUTS-2 regioner. Dekning per land vises i Tabell @tbl-coverage.


```{r}
# Regioner som mangler 2017 eller ikke har nok NUTS-3 til å beregne GINI
mangler_2017 <- gini_nuts2_year %>%
  dplyr::group_by(country, NUTS2) %>%
  dplyr::summarise(
    har_2017 = any(year == 2017),
    n_nuts3_2017 = dplyr::if_else(
      har_2017, max(n_nuts3[year == 2017], na.rm = TRUE), NA_real_),
    .groups = "drop"
  ) %>%
  dplyr::filter(!har_2017 | is.na(n_nuts3_2017) | n_nuts3_2017 < 2)

# Regioner som har 2017 men som mangler baseline-år for vekst 
har_2017 <- gini_nuts2_year %>% 
  dplyr::filter(year == 2017) %>% 
  dplyr::select(country, NUTS2) %>% 
  dplyr::distinct()

i_cs <- cs_2017 %>% dplyr::select(country, NUTS2) %>% dplyr::distinct()
mangler_i_cs <- dplyr::anti_join(har_2017, i_cs, by = c("country","NUTS2"))

mangler_2017   # til appendiks/notat
mangler_i_cs   # til appendiks/notat

```

## Modell

Vi undersøker om regional økonomisk utvikling henger sammen med ulikhet mellom regioner i 2017. Ulikhet måles som Gini på NUTS-2-nivå, og utvikling måles som vekst i BNP per innbygger fram til 2017. Tanken er at regioner som har vokst mer, kan få større forskjeller internt, men dette trenger ikke være sterkt eller gjelde overalt.

Sterkere økonomisk opphenting kan øke intern spredning (positivt β), men sammenhengen kan være svak og påvirkes av regionale strukturer og sammensetning.


```{r}
# Vis hva som faktisk er i kryss-snittet vårt ------------------------------
# (du bør allerede ha laget cs_2017 tidligere i dokumentet)
dplyr::glimpse(cs_2017)       # rask struktur
nrow(cs_2017)                 # antall regioner

coverage <- cs_2017 %>%
  dplyr::count(country, name = "n_nuts2")
coverage                      # dekning per land (skrives ut i pdf)

# OLS med robuste SE --------------------------------------------------------
m1 <- lm(gini_w ~ dev_log, data = cs_2017)

# Pene tabeller i dokumentet:
if (!requireNamespace("knitr", quietly = TRUE)) install.packages("knitr")
if (!requireNamespace("broom", quietly = TRUE)) install.packages("broom")
if (!requireNamespace("sandwich", quietly = TRUE)) install.packages("sandwich")
if (!requireNamespace("lmtest", quietly = TRUE)) install.packages("lmtest")

knitr::kable(broom::tidy(m1), caption = "OLS: GINI (2017) på utvikling (log-vekst)")
knitr::kable(broom::glance(m1), caption = "Modellmål (R², adj. R², n)")

# Robuste standardfeil (HC1)
lmtest::coeftest(m1, vcov = sandwich::vcovHC(m1, type = "HC1"))

```


## Resultater og tolkning

Modellen indikerer en positiv sammenheng mellom regional utvikling og ulikhet i 2017. Koeffisienten på utvikling er ...
t = r sprintf("%.2f", t_hc1), p= r format.pval(p_hc1, digits = 3) (n = r nobs_m1). Tolket i skala: rundt 10% høyere vekst (Δ log ≈ 0.10) er forbundet med r sprintf("%.3f", 0.10*beta_hat) høyere Gini i 2017. Modellen har moderat forklaringskraft (R^2 = r sprintf("%.2f", r2), justert R^2 = r sprintf("%.2f", r2a)), og spredingen i Figur @fig-ulikhet-utvikling viser at vekst alene ikke forklarer all variasjon mellom regioner. 




```{r}
# Figur ---------------------------------------------------------------------
ggplot2::ggplot(cs_2017, ggplot2::aes(x = dev_log, y = gini_w, label = NUTS2)) +
  ggplot2::geom_point() +
  ggplot2::geom_smooth(method = "lm", se = TRUE) +
  ggplot2::labs(
    x = "Regional utvikling (log-vekst i BNP p.c. til 2017)",
    y = "Regional ulikhet (GINI, NUTS-2, 2017)",
    title = "Ulikhet vs. utvikling (NUTS-2, våre land)",
    caption = "Utvikling: log(y2017) – log(y_baseline≥2000). GINI fra NUTS-3 i 2017."
  ) +
  ggplot2::theme_minimal()

```

## Slik leses figuren 

Figuren viser sammenhengen mellom regional utvikling (x-akse: log-vekst i BNP p.c. fram til 2017) og ulikhet (y-akse: Gini i 2017 på NUTS-2). Hver prikk er én region, den blå linjen er OLS-estimatet, og det grå båndet er 95% konfidensintervall. Helningen er svak positiv, som betyr at regioner med høyere vekst tenderer til noe høyere intern ulikhet i 2017. Usikkerheten er relativt stor (spesielt ved høy vekst, der vi har færre observasjoner), så vekst alene forklarer ikke all variasjon mellom regionene.


```{r}
# install.packages("ggrepel")
library(ggrepel)
ggplot(cs_2017, aes(dev_log, gini_w, label = NUTS2)) +
  geom_point() +
  geom_smooth(method = "lm", se = TRUE) +
  ggrepel::geom_text_repel(size = 3)

```
Figuren over viser den samme sammenhengen mellom utvikling og ulikhet som i hovedfiguren, men her er hver prikk merket med NUTS-2-koden til regionen. Det gjør det lettere å se hvilke regioner som driver mønsteret i dataene. For eksempel ligger EE00 høyt både på vekst og ulikhet, mens flere spanske regioner (ES-kodene) har forholdsvis lav ulikhet gitt utviklingsnivået sitt. Poenget er ikke å tolke hver enkelt region i detalj, men å illustrere hvilke konkrete regioner som ligger nærmest og lengst fra regresjonslinjen.


## Hva det betyr i praksis

Funnene peker på at sterk regional vekst kan følges av noe større forskjeller innad i regionen. For politikere og planleggere betyr det at tiltak som fremmer vekst kan med fordel kombineres med tiltak som sørger for bred deltakelse i verdiskapingen – for eksempel kompetanseheving, mobilitet i arbeidsmarkedet og inkluderende næringsutvikling.


# Del B: Andre drivkrefter bak regional ulikhet

I del A så vi på sammenhengen mellom regionalt utviklingsnivå (log BNP per innbygger) og inntektsulikhet målt ved Gini for 21 NUTS2 regioner i Estland, Slovenia, Tsjekkia, Østerrike og Spania. Det ga et første-bilde av hvordan rikere regioner skiller seg fra fattigere regioner. I del B utvider vi denne modellen ved å legge til tre regionale kjennetegn i 2017: andel av befolkningen med høyere utdanning, arbeidsledighetsrate og befolkningstetthet. Variablene hentes fra Eurostat og kobles til datasettet fra del A. Målet er å undersøke om disse faktorene kan bidra til å forklare hvorfor noen regioner har høyere inntektsulikhet enn andre, utover forskjeller i utviklingsnivå alene. 



```{r}
library(readxl)
library(dplyr)

# 1. Gini + evt. growth fra del A (bytt ut med deres objekt/fil)
gini_2017 <- gini_2017  # eller read_rds("gini_2017.rds") osv.

# 2. Utdanning
edu <- read_excel("edat_lfse_04_2017_tertiary_Y25_64.xlsx") |>
  rename(
    nuts2        = `GEO (Codes)`,
    edu_tertiary = `2017`
  ) |>
  filter(!is.na(edu_tertiary))

# 3. Arbeidsledighet
unemp <- read_excel("tgs00010_unemployment_2017.xlsx") |>
  rename(
    nuts2       = `GEO (Codes)`,
    unemp_rate  = `2017`
  ) |>
  filter(!is.na(unemp_rate))

# 4. Befolkningstetthet
dens <- read_excel("tgs00024_popdensity_2017.xlsx") |>
  rename(
    nuts2        = `GEO (Codes)`,
    pop_density  = `2017`
  ) |>
  filter(!is.na(pop_density))

# 5. slå sammen alt i ett datasett til del B
data_B <- gini_2017 |>
  left_join(edu,   by = c("NUTS2" = "nuts2")) |>
  left_join(unemp, by = c("NUTS2" = "nuts2")) |>
  left_join(dens,  by = c("NUTS2" = "nuts2"))

```

```{r}
glimpse(data_B)
nrow(data_B)  #Bare for å sjekke

```


```{r}
# Slå sammen utviklingsvariabelen inn i data_B
data_B2 <- data_B |>
  left_join(dev_2000_2017 |> select(NUTS2, dev_log),
            by = "NUTS2")

glimpse(data_B2)

```
```{r}
data_B3 <- data_B2 |>
  # Gjør utdanning, ledighet og tetthet om til tall
  dplyr::mutate(
    edu_tertiary = as.numeric(edu_tertiary),
    unemp_rate   = as.numeric(unemp_rate),
    pop_density  = as.numeric(pop_density)
  )

```

```{r}

#| label: save-data_B3
#| include: false

saveRDS(data_B3, file = "data/data_B3.rds")


```


```{r}
mod_B <- lm(
  # Linær regresjon for del B:
  # Gini forklart av utvikling + tre regionkjennetegn 
  gini_w ~ dev_log + edu_tertiary + unemp_rate + pop_density,
  data = data_B3
)

summary(mod_B)

```


I del B utvider vi modellen fra del A ved å inkludere tre regionale kjennetegn på NUTS2-nivå i 2017: andel med høyere utdanning, arbeidsledighetsrate og befolkningstetthet, i tillegg regionalt utviklingsnivå (log BNP per innbygger). Den utvidede modellen forklarer om lag 34% av variasjonen i Gini-koeffisienten mellom regionene (R² ≈ 0,34), men den justerte R²-verdien er bare 0,18. F-testene for hele modellen er ikke statistisk signifikant på 5-prosentnivå (p ≈ 0,13), og ingen av de enkelte forklaringsvariablene har signifilkante koeffisienter. Koeffisientene peker likevel i noen retninger som er interessante. Høyer BNP per innbygger og større andel med høyere utdanning er svakt positivt assosiert med høyere ulikhet. Høyere arbeidsledighet og høyere bfolkningstetthet er svakt negativt assosiert med ulikhet når vi holder de nadre variablene faste. Siden vi bare har 21 regioner og stpr usikkerhet rundt estimatene, bør disse sammenhengene tolkes som indikasjoner og ikke som sterke bevis for kausale effekter. 



# Del C: Kildebruk

I denne oppgaven bygger vi på hermoniserte, offisielle statistikkilder fra Eurostat og et Gini-datasett basert på EU-SILC levert som vi selv bearbeidet i Assignment 1. Nedenfor gir vi en kort oversikt over hvilke kilder som er brukt, hvordan de er koblet, og hvilke svakheter de kan ha.

## Datakilder

- Gini 2017 (EU-SILC, bearbeidet i Assignment 1)
Avhengig variabel er Gini-koeffisienten for disponible husholdningsinntekter i 2017 for NUTS2-regioner. Datasettet er konstruert av oss i Assignment 1, på grunnlag av EU-SILC-data og veiledning i emnet. Mulige svakheter er utvalgsusikkerhet og at små regioner kan ha mer støy i estimatene.

- Regionalt BNP per innbygger (Eurostat, nama_10r_3gdp)
Brukes til å beregne log BNP per innbygger i 2000 og 2017, samt vekst i utviklingsnivå. Dette er nasjonalt harmoniserte nasjonalregnskapsdata, men tallene kan være reviderte og sier lite om fordeling innad i regionene.

- Regional befolkning per 1. januar (Eurostat, demo_r_pjanaggr3) 
Ble brukt i Assingment 1 til å beregne befolkningsvekter og BNP per innbygger.

- Andel med høyere utdanning (Eurostat, arbeidskraftundersøkelser)
Variabelen edu_tertiary måler prosentandel av befolkningen 25–64 år med utdanning på nivå ED5–8. Dette er survey-baserte estimater og kan være noe usikre for små regioner.

- Arbeidsledighetsrate (Eurostat, tgs00010)
Måler registrert arbeidsledighet i prosent av arbeidsstyrken (15–74 år) på NUTS2-nivå. Tids- og definisjonsendringer kan påvirke sammenlignbarheten, men dataserien er harmonisert av Eurostat.

- Befolkningstetthet (Eurostat, tgs00024)
Antall personer per km² i 2017. Denne brukes som et enkelt mål på hvor urbane regionene er. En svakhet er at tetthet ikke fanger opp alle sider ved urbanisering og infrastruktur.


## Bruk av KI-verktøy (I tråd med HVL sin bruk av KI)

I oppgaven har vi brukt ChatGPT som støtteverktøy, i tråd med HVL sine retningslinjer for bruk av kunstig intelligens. KI-verktøyet ble brukt gjennom nettversjonen av ChatGPT (OpenAI, modell GPT-5.1 Thinking).

ChatGPT er brukt til å få forslag til og feilsøke R-kode. Alle valg av variabler, modellspesifikasjon, tolkning av resultater og konklusjoner er våre egne, basert på pensum og oppgaveteksten. Prompt-strategien har vært å stille konkrete, avgrensede spørsmål, for eksempel om en bestemt feilmelding i R. Svarene er blitt vurdert kritisk og testet mot egne resultater før de eventuelt er tatt i bruk. 



